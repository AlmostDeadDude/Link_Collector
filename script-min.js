let RESULTS=[],VALIDATION={url:!1,cat:!1,tags:!1,reset(){this.url=!1,this.cat=!1,this.tags=!1}},MSG_STATUS=!1;const DEFAULT_TAGS=["javascript","css","api","design","learning","productivity"],DEFAULT_CATS=["Frontend fundamentals","Practice & tutorials","APIs & backend","Design & inspiration","Career & learning paths","Reading list"],DEFAULT_COLLECTION=[{linkID:"demo-1",linkURL:"https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Flexbox",linkCATEGORY:"Frontend fundamentals",linkTAGS:"-css-layout-reference-",linkDATE:"12-03-2024"},{linkID:"demo-2",linkURL:"https://javascript30.com/",linkCATEGORY:"Practice & tutorials",linkTAGS:"-javascript-challenge-video-",linkDATE:"05-02-2024"},{linkID:"demo-3",linkURL:"https://www.postman.com/explore",linkCATEGORY:"APIs & backend",linkTAGS:"-api-testing-collections-",linkDATE:"18-01-2024"},{linkID:"demo-4",linkURL:"https://www.figma.com/community",linkCATEGORY:"Design & inspiration",linkTAGS:"-ui-components-community-",linkDATE:"10-12-2023"}],synchroTags=(e,t)=>{e.addEventListener("input",(function(){let e=this.value.toLowerCase().split(","),n=[];for(let a=0;a<e.length;a++)for(let s=0;s<t.children.length;s++)t.children[s].innerText.toLowerCase()===e[a].trim()&&n.push(t.children[s]);for(let e=0;e<t.children.length;e++)n.includes(t.children[e])?t.children[e].classList.add("selected"):t.children[e].classList.remove("selected")})),[...t.children].forEach((t=>{t.addEventListener("click",(function(){if(this.classList.contains("selected")){this.classList.remove("selected");let t=this.innerText,n=e.value.split(","),a=[];for(let e=0;e<n.length;e++)n[e].trim()!==t&&a.push(n[e].trim());e.value=a.join(",")}else{this.classList.add("selected");let t=this.innerText,n=e.value.trim();","===n.charAt(n.length-1)&&(n=n.slice(0,n.length-1));let a=n.split(",");a.push(t),e.value=a.join(",")}","===e.value.charAt(0)&&(e.value=e.value.slice(1)),e.value.includes("-")?VALIDATION.tags=!1:VALIDATION.tags=!0}))}))},prepareAddForm=()=>{const e=document.getElementById("form-add"),t=document.getElementById("add_url"),n=document.getElementById("add_categorie"),a=document.getElementById("add_tags"),s=document.getElementById("tagsInAdd");t.addEventListener("input",(e=>{const n=e.target.value;t.classList.contains("invalid")&&t.classList.remove("invalid"),urlCheck=/^(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?$/i,urlCheck.test(n)?(t.previousElementSibling.querySelector("span").className="approved",VALIDATION.url=!0):(t.previousElementSibling.querySelector("span").className="",VALIDATION.url=!1)})),n.addEventListener("input",(e=>{const t=e.target.value;n.classList.contains("invalid")&&n.classList.remove("invalid"),"-- select an option --"!==t?(n.previousElementSibling.querySelector("span").className="approved",VALIDATION.cat=!0):(n.previousElementSibling.querySelector("span").className="",VALIDATION.cat=!1)})),a.addEventListener("input",(e=>{const t=e.target.value;a.classList.contains("invalid")&&a.classList.remove("invalid"),t.includes("-")?(a.previousElementSibling.querySelector("span").className="",VALIDATION.tags=!1):(a.previousElementSibling.querySelector("span").className="approved",VALIDATION.tags=!0)})),e.addEventListener("submit",(async i=>{if(i.preventDefault(),!VALIDATION.url)return void t.classList.add("invalid");if(!VALIDATION.cat)return void n.classList.add("invalid");if(!VALIDATION.tags)return void a.classList.add("invalid");const d=t.value,l=n.options[n.selectedIndex].text;let o=a.value;const r=o.split(","),c=[];r.forEach((e=>{""!==e.trim()&&c.push(e.trim())}));let m=c.join(",");","===m.charAt(m.length-1)&&(m=m.slice(0,m.length-1)),a.value=m,o=a.value;if(document.getElementById("tagsCheckbox").checked){const e=await fetch(`updateTags.php?add_tag=${o}`),t=await e.text();"OK"!==t&&showMsg(t,"bad"),await updateTagsCats()}const u=await fetch(`add.php?url=${d}&category=${l}&tags=${o}`),g=await u.text();"OK"!==g&&showMsg(g,"bad"),e.reset(),t.previousElementSibling.querySelector("span").className="",n.previousElementSibling.querySelector("span").className="",a.previousElementSibling.querySelector("span").className="",s.querySelectorAll(".selected").forEach((e=>{e.classList.remove("selected")})),await prepareCollection(),VALIDATION.reset();let p=d;d.length>26&&(p=d.slice(0,26)+"..."),showMsg(`The link&nbsp;<span>${p}</span>&nbsp;was added to the collection`),document.getElementById("card-add").classList.add("hide")}))},prepareRandomForm=()=>{const e=document.getElementById("form-random"),t=document.getElementById("random_categorie"),n=document.getElementById("random_tags"),a=document.getElementById("tagsInRandom");t.addEventListener("input",(e=>{t.classList.contains("invalid")&&t.classList.remove("invalid")})),e.addEventListener("submit",(async s=>{s.preventDefault();const i=t.options[t.selectedIndex].text,d=n.value;if("-- select an option --"===i)return void t.classList.add("invalid");const l=await fetch(`random.php?&category=${i}&tags=${d}`),o=await l.text();if(o.startsWith("error"))showMsg(o,"bad");else{const e=JSON.parse(o);RESULTS=Array.isArray(e)?e:[],document.getElementById("card-random").classList.add("hide"),0===e.length?document.getElementById("card-no-results").classList.remove("hide"):fillResultsCard()}e.reset(),a.querySelectorAll(".selected").forEach((e=>{e.classList.remove("selected")}))}))},fillResultsCard=()=>{if(!Array.isArray(RESULTS)||0===RESULTS.length)return showMsg("No results to show. Try a different category/tags.","info"),void document.getElementById("card-random-result").classList.add("hide");const e=Math.floor(Math.random()*RESULTS.length),t=RESULTS[e];RESULTS.splice(e,1),0===RESULTS.length?(document.getElementById("more").classList.add("disabled"),document.getElementById("more").disabled=!0):(document.getElementById("more").classList.remove("disabled"),document.getElementById("more").disabled=!1),document.getElementById("linkToShow").innerHTML=t.linkURL,document.getElementById("openURL").href=t.linkURL,document.getElementById("copyURL").href=t.linkURL,document.getElementById("categorieToShow").innerHTML=t.linkCATEGORY,document.getElementById("dateToShow").innerHTML=t.linkDATE;let n="string"==typeof t.linkTAGS?t.linkTAGS.slice(1,t.linkTAGS.length-1).split("-"):["misc"];document.getElementById("card-random-result").querySelector(".existing-tags").innerHTML="",n.forEach((e=>{let t=document.createElement("div");t.className="existing-tag selected",t.innerHTML=e,document.getElementById("card-random-result").querySelector(".existing-tags").appendChild(t)}));const a=document.getElementById("more").parentElement,s=document.createElement("button");s.id="linkRemove",s.className="card-button",s.innerHTML="Remove link",s.addEventListener("click",(async()=>{if(confirm("Are you sure you want to remove this link from the collection?")){const e=await fetch(`delete.php?id=${t.linkID}`),n=await e.text();"OK"!==n?showMsg(n,"bad"):(await prepareCollection(),RESULTS.length>0?fillResultsCard():(document.getElementById("card-random-result").classList.add("hide"),showMsg("There are no other links matching your search criteria","info")))}})),a.replaceChild(s,document.getElementById("linkRemove")),document.getElementById("card-random-result").classList.remove("hide")};document.getElementById("more").addEventListener("click",(()=>{Array.isArray(RESULTS)&&RESULTS.length>0&&fillResultsCard()}));const prepareCollection=async()=>{const e=document.getElementById("card-collection").querySelector("tbody");e.innerHTML="";let t=[];try{const e=await fetch("collection.php"),n=await e.text();if(n.startsWith("error"))showMsg(n,"bad"),t=DEFAULT_COLLECTION;else{const e=JSON.parse(n);t=Array.isArray(e)?e:DEFAULT_COLLECTION}}catch(e){t=DEFAULT_COLLECTION}t.forEach((t=>{const n=("string"==typeof t.linkTAGS?t.linkTAGS:"-misc-").replace(/(^-+|-+$)/g,""),a=n?n.split("-").filter((e=>""!==e.trim())):["misc"],s=t.linkDATE||"n/a";let i=document.createElement("tr"),d=`\n            <td>\n                <a href="${t.linkURL}" target="_blank" rel="noopener noreferrer">\n                    <i class="fa-solid fa-arrow-up-right-from-square"></i>\n                </a>\n            </td>\n            <td>${t.linkCATEGORY||"Uncategorised"}</td>\n            <td><div class="existing-tags">`;a.forEach((e=>{d+=`<div class="existing-tag selected">${e}</div>`})),d+=`\n            </div></td>\n            <td>${s}</td>`,i.innerHTML=d;let l=document.createElement("td");l.innerHTML='<i class="fa-solid fa-trash"></i>',l.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete this link?")){const e=await fetch(`delete.php?id=${t.linkID}`),n=await e.text();"OK"!==n?showMsg(n,"bad"):i.remove()}})),i.appendChild(l),e.appendChild(i)}))},prepareSettingsCats=()=>{const e=document.getElementById("updateCats");e.addEventListener("submit",(async t=>{t.preventDefault();const n=document.getElementById("add_cat"),a=document.getElementById("remove_cat"),s=a.options[a.selectedIndex].text,i=await fetch(`updateCats.php?add_cat=${n.value}&remove_cat=${s}`),d=await i.text();"OK"!==d&&showMsg(d,"bad"),await updateTagsCats(),e.reset(),document.getElementById("card-configure").classList.add("hide"),showMsg("Categories list updated","good")}))},prepareSettingsTags=()=>{const e=document.getElementById("updateTags");e.addEventListener("submit",(async t=>{t.preventDefault();const n=document.getElementById("add_tag"),a=document.getElementById("remove_tag"),s=a.options[a.selectedIndex].text,i=await fetch(`updateTags.php?add_tag=${n.value}&remove_tag=${s}`),d=await i.text();"OK"!==d&&showMsg(d,"bad"),await updateTagsCats(),e.reset(),document.getElementById("card-configure").classList.add("hide"),showMsg("Tags list updated","good")}))},updateTagsCats=async()=>{let e;try{const t=await fetch("getTagsCats.php?"),n=await t.text();if(n.startsWith("latest error"))throw new Error(n);e=JSON.parse(n)}catch(t){e=[DEFAULT_TAGS,DEFAULT_CATS]}TAGS=Array.isArray(e[0])?e[0]:DEFAULT_TAGS,CATS=Array.isArray(e[1])?e[1]:DEFAULT_CATS;let t=document.getElementById("tagsInAdd"),n=document.getElementById("tagsInRandom"),a=document.getElementById("remove_tag");t.innerHTML="",n.innerHTML="",a.innerHTML="<option disabled selected> -- select an option -- </option>",TAGS.forEach((e=>{let s=document.createElement("div"),i=document.createElement("option");s.classList.add("existing-tag"),s.innerText=e,i.innerText=e,t.appendChild(s),n.appendChild(s.cloneNode(!0)),a.appendChild(i)})),synchroTags(document.getElementById("add_tags"),t),synchroTags(document.getElementById("random_tags"),n);let s=document.getElementById("add_categorie"),i=document.getElementById("random_categorie"),d=document.getElementById("remove_cat");s.innerHTML="<option disabled selected> -- select an option -- </option>",i.innerHTML="<option disabled selected> -- select an option -- </option>",d.innerHTML="<option disabled selected> -- select an option -- </option>",CATS.forEach((e=>{let t=document.createElement("option");t.innerText=e,s.appendChild(t),i.appendChild(t.cloneNode(!0)),d.appendChild(t.cloneNode(!0))}))},showMsg=(e,t="good",n=3e3)=>{if(!MSG_STATUS){MSG_STATUS=!0;const a=document.getElementById("msg");let s,i;s="good"===t?'<div><i class="fa-solid fa-check"></i></div>':"bad"===t?'<div><i class="fa-solid fa-exclamation"></i></div>':"facepalm"===t?'<div><img src="img/facepalm.png" alt="Caïn venant de tuer son frère Abel, by Henri Vidal in Tuileries Garden in Paris, France | https://www.flickr.com/photos/proimos/4199675334/ | Alex E. Proimos | Attribution-NonCommercial 2.0 Generic (CC BY-NC 2.0)"></div>':'<div><i class="fa-solid fa-info"></i></div>',i=e.length<75?20:e.length<130?16:14,a.innerHTML=`${s}<div style="font-size:${i}px">${e}</div>`,a.className=t,setTimeout((()=>{a.className="",MSG_STATUS=!1}),n)}};document.getElementById("board").addEventListener("click",(async()=>{const e=await fetch("https://icanhazdadjoke.com",{headers:{Accept:"application/json"}}),t=await e.json();showMsg(t.joke,"facepalm","5000")}));const options=document.getElementById("options"),copyURL=document.getElementById("copyURL");let TAGS,CATS;window.onload=async function(){await updateTagsCats(),prepareAddForm(),prepareRandomForm(),prepareSettingsCats(),prepareSettingsTags(),await prepareCollection(),document.getElementById("title").className="show",document.getElementById("options").className="show",document.getElementById("bookshelf").className="show",document.querySelector("footer").className="show"};const optionsArray=[...options.children];optionsArray.forEach((e=>{document.querySelectorAll("card-background").forEach((e=>{e.className="hide"})),e.addEventListener("click",(()=>{document.getElementById(`card-${e.id}`).classList.remove("hide"),window.scrollTo(0,0),document.body.style.overflowY="hidden"}))})),document.querySelectorAll(".card-close").forEach((e=>{e.addEventListener("click",(()=>{e.parentElement.parentElement.classList.add("hide"),document.body.style.overflowY="auto"}))})),document.getElementById("no-results-ok").addEventListener("click",(()=>{document.getElementById("card-no-results").classList.add("hide"),document.getElementById("card-random").classList.remove("hide")})),copyURL.addEventListener("click",(e=>{e.preventDefault(),navigator.clipboard.writeText(copyURL.href)}));